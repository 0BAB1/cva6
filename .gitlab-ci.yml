stages:
  - build
  - test
  - deploy

build_rtl:
  stage: build
  script:
    - make build

test_alu:
  stage: test
  before_script:
    - make build library=alu
  script:
    - make alu library=alu
    - vcover report alu.ucdb
    - vcover report -html alu.ucdb
  artifacts:
    paths:
      - covhtmlreport

test_fifo:
  stage: test
  before_script:
    - make build library=fifo
  script:
    - make fifo library=fifo
    - vcover report fifo.ucdb
    - vcover report -html fifo.ucdb
  artifacts:
    paths:
      - covhtmlreport

test_scoreboard:
  stage: test
  before_script:
    - make build library=scoreboard
  script:
    - make scoreboard library=scoreboard
    - vcover report scoreboard.ucdb
    - vcover report -html scoreboard.ucdb
  artifacts:
    paths:
      - covhtmlreport

test_mem_arbiter:
  stage: test
  before_script:
    - make build library=mem_arbiter
  script:
    - make mem_arbiter library=mem_arbiter
    - vcover report mem_arbiter.ucdb
    - vcover report -html mem_arbiter.ucdb
  artifacts:
    paths:
      - covhtmlreport

test_store_queue:
  stage: test
  before_script:
    - make build library=store_queue
  script:
    - make store_queue library=store_queue
    - vcover report store_queue.ucdb
    - vcover report -html store_queue.ucdb
  artifacts:
    paths:
      - covhtmlreport

test_lsu:
  stage: test
  before_script:
    - make build library=lsu
  script:
    - make lsu library=lsu
    - vcover report lsu.ucdb
    - vcover report -html lsu.ucdb
  artifacts:
    paths:
      - covhtmlreport


pages:
  stage: deploy
  dependencies:
    - test_alu
    - test_fifo
    - test_scoreboard
    - test_mem_arbiter
    - test_mem_arbiter
  script:
    - mkdir public
    - mkdocs build -d public
    - mv covhtmlreport/ public/
    - lftp -e "mirror -R public . ; quit;" -u $FTP_USER,$FTP_PASSWORD $FTP_HOST
  artifacts:
    paths:
      - site


